<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
    #features {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 400px;
        height: 300px;
        overflow: auto;
        background: rgba(255, 255, 255, 0.8);
    }
    #pic {
        width: 100%;
        height: 100%;
    }
    #map canvas {
        cursor: crosshair;
    }
</style>
<div id='map'></div>
<pre id='features'>
    <div id='pic'><div>
</pre>
<script>

var frame = document.querySelector('#pic')

function getPhoto(lon, lat) {
    var uri = `https://api.flickr.com/services/rest/?method=flickr.photos.search& \
  api_key=9edf145e07ba220c42ade82e1759810d&lat=${lat}&lon=${lon} \  
  &accuracy=1&sort=interestingness-desc&extras=url_l&format=json&nojsoncallback=1`;

  fetch(uri)
    .then(res => {
        return res.json();
    })
    .then(data => {
        var photoArray = data.photos.photo[Math.floor(Math.random()*data.photos.photo.length)] || {"url_l":""}
        frame.style.background = `url(${photoArray.url_l})`;
        frame.style['background-size'] = '100%';
        frame.style['background-repeat'] = 'no-repeat';
        
    })
    .catch(console.log)

}

mapboxgl.accessToken = 'pk.eyJ1IjoiZGxhcnJhYmVlIiwiYSI6ImNqMmIyZm5kZDAwcWcyd3M2ajNweWdlYTIifQ.bkwEq-z6kmsc7Jw7CDDr1w';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [-122.3235, 47.5929],
    zoom: 12
});

var throttled = false;

map.on('mousemove', function (e) {
    var features = map.queryRenderedFeatures(e.point);
    if(!throttled && features[0]) {

        var coordinates = features[0].geometry.coordinates[0][Math.floor(Math.random()*features[0].geometry.coordinates[0].length)];
        
        if (coordinates && Array.isArray(coordinates) && coordinates.length === 2) {
            getPhoto(coordinates[0], coordinates[1]);
            console.log(coordinates);
            throttled = true;
            setTimeout(() => throttled = false, 1000);
        }
    }
});
</script>

</body>
</html>
